/**
 * Controls the notebook index.
 *
 * @module     local_notebook/notebook_index
 * @copyright  2022 Université de Montréal
 * @author     Issam Taboubi <issam.taboubi@umontreal.ca>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
require.config({enforceDefine:!0,shim:{bootstrapTable:["jquery"],bootstrapTableLocale:["jquery","bootstrapTable"],bootstrapTableLocaleMobile:["jquery","bootstrapTable"]},paths:{bootstrapTable:M.cfg.wwwroot+"/local/notebook/amd/build/bootstrap-table.min",bootstrapTableLocale:M.cfg.wwwroot+"/local/notebook/amd/build/bootstrap-table-locale-all.min",bootstrapTableLocaleMobile:M.cfg.wwwroot+"/local/notebook/amd/build/bootstrap-table-mobile.min"}}),define("local_notebook/notebook_index",["jquery","core/notification","core/str","core/ajax","core/templates","bootstrapTable","bootstrapTableLocale","bootstrapTableLocaleMobile"],(function($,notification,str,ajax,Templates){var SELECTORS={NOTEBOOKCONTAINER:".notebookcontainer",NOTEINDEX:'[data-region="notebook-index"]',HEADER_CONTAINER:'[data-region="header-container"]',BODY_CONTAINER:'[data-region="body-container"]',FORM_CONTAINER:'[data-region="form-note"]',CLOSE_BUTTON:'[data-action="closedrawer"]',NOTE_TABLE_CONTAINER:"#notebook-table-index-container",NOTE_TABLE:"#notebook-table-index",NOTE_TABLE_LOADING:"#notebook-table-index-loading",REFRESH_BUTTON:'button[name="refresh"]',SAVE_BUTTON:"#savenote",CANCEL_BUTTON:"#cancel-add-edit",NOTE_FORM_ID:"noteform",NOTE_SUMMARY:"#id_notebook_editor",VIEW_NOTE:"#notebook-table-index .viewnote",NOTE_VIEW:'[data-region="notebook-index"] .view-note',NOTE_TABLE_ROW:"#notebook-table-index tr",FOOTER_NOTE_VIEW:'[data-region="footer-container"] [data-region="view-note"]',HEADER_NOTE_VIEW:'[data-region="header-container"] [data-region="view-note"]',HEADER_NOTE_CREATED_DATE:'[data-region="header-container"] .notecreateddate',HEADER_NOTE_LAST_MODIFIED_DATE:'[data-region="header-container"] .notelastmodifieddate',NOTE_FORM:'[data-region="form-note"] #noteform',HEADER_NOTE_DELETE:'[data-region="header-container"] .deletenote',HEADER_NOTE_EDIT:'[data-region="header-container"] .editnote',FOOTER_NOTE_TAGS:'[data-region="footer-container"] .notetags',MESSAGE_SUCCESS_CONTAINER:".notebookcontainer .messagesuccesscontainer",DIALOGUE_CONTAINER:'.notebookcontainer [data-region="confirm-dialogue-container"]',CONFIRM_TEXT_MULTI:'.notebookcontainer [data-region="confirm-dialogue-container"] .multiplenotes',CONFIRM_TEXT_SINGLE:'.notebookcontainer [data-region="confirm-dialogue-container"] .singlenote',CONFIRM_DELETE_BUTTON_MULTI:'[data-region="confirm-dialogue-container"] [data-action="confirm-delete-multiple"]',CONFIRM_DELETE_BUTTON_SINGLE:'[data-region="confirm-dialogue-container"] [data-action="confirm-delete-single"]',CANCEL_DELETE_BUTTON_MULTI:'[data-region="confirm-dialogue-container"] [data-action="cancel-delete-multiple"]',CANCEL_DELETE_BUTTON_SINGLE:'[data-region="confirm-dialogue-container"] [data-action="cancel-delete-single"]',DELETE_NOTE_BUTTON:".deletenote",CHECKBOX_LIST_NOTE:'[name="btSelectItem"]',CHECKBOX_ALL_NOTE:'[name="btSelectAll"]',TABLE_DELETE_BUTTON:'[data-region="notebook-index"] #remove',TABLE_PAGINATION:'[data-region="notebook-index"] .fixed-table-pagination',NOTE_DETAIL_CONTAINER:"#notedetailcontainer"},refreshNotes=()=>{let previousPageNumber=this.$table.bootstrapTable("getOptions").pageNumber;this.$table.bootstrapTable("destroy"),displayNotes(previousPageNumber)},displayNote=noteid=>{var promises=[];displayNoteView(),(()=>{let selectors=SELECTORS.FOOTER_NOTE_VIEW+", "+SELECTORS.HEADER_NOTE_CREATED_DATE+", "+SELECTORS.HEADER_NOTE_LAST_MODIFIED_DATE+", "+SELECTORS.NOTE_VIEW;$(selectors).addClass("blur-content")})(),(promises=ajax.call([{methodname:"local_notebook_read_note",args:{noteid:noteid}},{methodname:"local_notebook_note_viewed",args:{id:noteid}}]))[0].done((function(result){let data={};data.subject=result.subject,data.summary=result.summary;let timestamp=1e3*result.created,datecreation=new Date(timestamp).toLocaleDateString(document.documentElement.lang,{day:"numeric",month:"short",year:"numeric"}),timecreation=new Date(timestamp).toLocaleTimeString(document.documentElement.lang),lastmodifiedtimestamp=1e3*result.lastmodified,lastmodifieddate=new Date(lastmodifiedtimestamp).toLocaleDateString(document.documentElement.lang,{day:"numeric",month:"short",year:"numeric"}),lastmodifiedtime=new Date(lastmodifiedtimestamp).toLocaleTimeString(document.documentElement.lang);Templates.render("local_notebook/note_content",data).then((function(html){var tags,tagshtml;return $(SELECTORS.NOTE_VIEW).html(html),$(SELECTORS.HEADER_NOTE_CREATED_DATE).html(datecreation+" "+timecreation),$(SELECTORS.HEADER_NOTE_LAST_MODIFIED_DATE).html(lastmodifieddate+" "+lastmodifiedtime),$(SELECTORS.HEADER_NOTE_DELETE).data("noteid",result.id),$(SELECTORS.HEADER_NOTE_EDIT).data("noteid",result.id),$(SELECTORS.FOOTER_NOTE_TAGS).html((tags=result.tags,tagshtml="",tags.forEach((function(item){let badge="badge-info badge-pill";"#"===item.url?(badge="badge-secondary",tagshtml+='<span class="badge '+badge+' text-truncate context-note" title="'+item.tooltip+'">'+item.title+"</span>"):tagshtml+='<span class="badge '+badge+' text-truncate context-note"><a title="'+item.tooltip+'" href="'+item.url+'">'+item.title+"</a></span>"})),tagshtml)),(()=>{let selectors=SELECTORS.FOOTER_NOTE_VIEW+", "+SELECTORS.HEADER_NOTE_CREATED_DATE+", "+SELECTORS.HEADER_NOTE_LAST_MODIFIED_DATE+", "+SELECTORS.NOTE_VIEW;$(selectors).removeClass("blur-content")})(),promises[1].done((function(){})).fail(Notification.exception)})).fail(Notification.exception)})).fail(Notification.exception)},displayNotes=pageNumber=>{var promises=[];promises=ajax.call([{methodname:"local_notebook_notes_list",args:{userid:this.userid,courseid:this.courseid,coursemoduleid:this.coursemoduleid}}]);str.get_strings([{key:"notetitle",component:"local_notebook"},{key:"notedate",component:"local_notebook"},{key:"displaynote",component:"local_notebook"},{key:"lastmodifieddate",component:"local_notebook"}]).then((function(langStrings){let data=[];promises[0].done((function(result){$.each(result,(function(index,value){let subject={};subject.text=value.subject,subject.tags=value.tags,data.push({id:value.id,subjecttext:value.subject,subject:subject,lastmodified:value.lastmodified})})),this.$table.bootstrapTable({locale:document.documentElement.lang,paginationParts:["pageInfo","pageSize","pageList"],paginationSuccessivelySize:2,paginationPagesBySide:1,data:data,pageNumber:pageNumber,columns:[[{field:"state",checkbox:!0},{field:"subjecttext",visible:!1},{field:"subject",title:langStrings[0],sortable:!0,sortName:"subjecttext",formatter:function(value){let nbtags=value.tags.length;var td="<span class='text-truncate subject'>"+value.text+"</span><br>",nbclass=1===nbtags?"wcn-1":"wcn-2";return value.tags.forEach((function(item){let badge="badge-info badge-pill";"#"===item.url?(badge="badge-secondary",td+='<span class="badge '+badge+" text-truncate context-note "+nbclass+'" title="'+item.tooltip+'">'+item.title+"</span>"):td+='<span class="badge '+badge+" text-truncate context-note "+nbclass+'"><a title="'+item.tooltip+'" href="'+item.url+'">'+item.title+"</a></span>"})),td}},{field:"lastmodified",title:langStrings[1],sortable:!0,formatter:function(value){return new Date(1e3*value).toLocaleDateString(document.documentElement.lang,{day:"numeric",month:"short",year:"numeric"})},width:110,titleTooltip:langStrings[3]},{field:"operate",title:"",align:"center",width:35,formatter:function(value,row){return['<a class="viewnote" data-noteid="'+row.id+'" href="#notedetailcontainer" title="'+langStrings[2]+'">','<i class="fa fa-chevron-right" aria-hidden="true"></i>',"</a>"].join("")}}]],onPostBody:function(){$(".card-views").each((function(){$(this).find(".card-view").slice(1,3).wrapAll('<div class="item-content" />')})),$(SELECTORS.NOTE_TABLE_LOADING).addClass("hidden"),$(SELECTORS.NOTE_TABLE_CONTAINER).removeClass("hidden"),$(SELECTORS.TABLE_PAGINATION+" .dropdown-toggle").dropdown()}})})).fail(notification.exception)})).fail(Notification.exception)},closeConfirmDialogue=(action,focus)=>{$(SELECTORS.DIALOGUE_CONTAINER).addClass("hidden"),focus&&("multiple"===action?$(SELECTORS.TABLE_DELETE_BUTTON).focus():$(SELECTORS.DELETE_NOTE_BUTTON).focus())},showConfirmDialogue=action=>{if($(SELECTORS.DIALOGUE_CONTAINER).removeClass("hidden"),"multiple"===action){let toshow=SELECTORS.CONFIRM_TEXT_MULTI+", "+SELECTORS.CONFIRM_DELETE_BUTTON_MULTI+","+SELECTORS.CANCEL_DELETE_BUTTON_MULTI,tohide=SELECTORS.CONFIRM_TEXT_SINGLE+", "+SELECTORS.CONFIRM_DELETE_BUTTON_SINGLE+","+SELECTORS.CANCEL_DELETE_BUTTON_SINGLE;$(tohide).addClass("hidden"),$(toshow).removeClass("hidden");let list=[];$(SELECTORS.NOTEINDEX+" "+SELECTORS.CHECKBOX_LIST_NOTE+":checked").each((function(){list.push($(this).val())})),$(SELECTORS.CONFIRM_DELETE_BUTTON_MULTI).data("noteid",list),$(SELECTORS.CONFIRM_DELETE_BUTTON_MULTI).focus()}else{let tohide=SELECTORS.CONFIRM_TEXT_MULTI+", "+SELECTORS.CONFIRM_DELETE_BUTTON_MULTI+","+SELECTORS.CANCEL_DELETE_BUTTON_MULTI,toshow=SELECTORS.CONFIRM_TEXT_SINGLE+", "+SELECTORS.CONFIRM_DELETE_BUTTON_SINGLE+","+SELECTORS.CANCEL_DELETE_BUTTON_SINGLE;$(tohide).addClass("hidden"),$(toshow).removeClass("hidden"),$(SELECTORS.CONFIRM_DELETE_BUTTON_SINGLE).data("noteid",$(SELECTORS.HEADER_NOTE_DELETE).data("noteid")),$(SELECTORS.CONFIRM_DELETE_BUTTON_SINGLE).focus()}window.scrollTo(0,$(SELECTORS.DIALOGUE_CONTAINER).position().top)},submitFormAjax=()=>{if("reset"==$(document.activeElement).data("action"))cancelNoteForm();else{if(isEmpty())return void toggleSaveButton();let args={};args.noteid=$(SELECTORS.NOTE_FORM+' input[name="noteid"]').val(),args.subject=$(SELECTORS.NOTE_FORM+' input[name="subject"]').val(),args.note=$(SELECTORS.NOTE_SUMMARY).val(),ajax.call([{methodname:"local_notebook_update_note",args:args,done:function(result){result&&(refreshNotes(),displayMessageSuccess("notesaved"),displayNoteView(),displayNote(args.noteid))},fail:notification.exception}])}return!1},submitDeleteAjax=()=>{let action=$(document.activeElement).data("action"),notesids=[],keymessage="notedeleted";return"confirm-delete-multiple"===action?(notesids=$(document.activeElement).data("noteid"),keymessage="notedeletedmultiple"):notesids.push($(document.activeElement).data("noteid")),ajax.call([{methodname:"local_notebook_delete_notes",args:{notes:notesids},done:function(result){result&&(closeConfirmDialogue("multiple",!1),hideNoteView(!1),displayMessageSuccess(keymessage),refreshNotes(),hideNoteForm())},fail:notification.exception}]),!1},cancelNoteForm=()=>{displayNoteView(),$(SELECTORS.HEADER_NOTE_EDIT).focus()},isTinyMceEditor=()=>void 0!==window.tinyMCE,getTinyMce=()=>window.tinyMCE.get(SELECTORS.NOTE_SUMMARY.replace("#","")),hideNoteView=focus=>{$(SELECTORS.HEADER_NOTE_VIEW).addClass("hidden"),$(SELECTORS.HEADER_NOTE_VIEW).attr("aria-hidden",!0),$(SELECTORS.FOOTER_NOTE_VIEW).addClass("hidden"),$(SELECTORS.FOOTER_NOTE_VIEW).attr("aria-hidden",!0),$(SELECTORS.NOTE_VIEW).addClass("hidden"),$(SELECTORS.NOTE_VIEW).attr("aria-hidden",!0),$(SELECTORS.FORM_CONTAINER).removeClass("hidden"),$(SELECTORS.FORM_CONTAINER).removeAttr("aria-hidden"),focus&&($(focus).focus(),isTinyMceEditor()?(getTinyMce().on("KeyUp",toggleSaveButton),getTinyMce().on("ExecCommand",toggleSaveButton)):$(SELECTORS.FORM_CONTAINER+" form textarea").on("change",toggleSaveButton),$(SELECTORS.FORM_CONTAINER+' form input[type="text"]').on("input",toggleSaveButton))},hideNoteForm=()=>{$(SELECTORS.FORM_CONTAINER).addClass("hidden"),$(SELECTORS.FORM_CONTAINER).attr("aria-hidden",!0)},displayNoteView=()=>{$(SELECTORS.HEADER_NOTE_VIEW).removeClass("hidden"),$(SELECTORS.HEADER_NOTE_VIEW).removeAttr("aria-hidden"),$(SELECTORS.FOOTER_NOTE_VIEW).removeClass("hidden"),$(SELECTORS.FOOTER_NOTE_VIEW).removeAttr("aria-hidden"),$(SELECTORS.NOTE_VIEW).removeClass("hidden"),$(SELECTORS.NOTE_VIEW).removeAttr("aria-hidden"),$(SELECTORS.FORM_CONTAINER).addClass("hidden"),$(SELECTORS.FORM_CONTAINER).attr("aria-hidden",!0)},displayMessageSuccess=key=>{$(SELECTORS.MESSAGE_SUCCESS_CONTAINER).html("");var stringkeys=[{key:key,component:"local_notebook"},{key:"close",component:"core"}];str.get_strings(stringkeys).then((function(langStrings){let messageHtml='<div class="alert alert-success alert-block fade in " role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="'+langStrings[1]+'">×</button>'+langStrings[0]+"</div>";$(SELECTORS.MESSAGE_SUCCESS_CONTAINER).html(messageHtml),$(SELECTORS.MESSAGE_SUCCESS_CONTAINER+" .alert button").focus(),setTimeout((function(){$(SELECTORS.MESSAGE_SUCCESS_CONTAINER+" .alert").fadeOut()}),1e4)}))},toggleSaveButton=()=>{$(SELECTORS.NOTE_FORM+" "+SELECTORS.SAVE_BUTTON).prop("disabled",isEmpty())},isEmpty=()=>{let editorcontent=isTinyMceEditor()?getTinyMce().getContent():$(SELECTORS.FORM_CONTAINER+" #id_notebook_editoreditable").html(),emptyTitle=""==$(SELECTORS.NOTE_FORM+' input[type="text"]').val(),emptyEditor=void 0!==editorcontent&&0===editorcontent.replace(/<(.|\n)*?>/g,"").trim().length&&!editorcontent.includes("<img");return emptyTitle||emptyEditor},toggleDeleteButton=()=>{let listempty=!0;$(SELECTORS.NOTEINDEX+" "+SELECTORS.CHECKBOX_LIST_NOTE+":checked").length>0&&(listempty=!1),listempty?$(SELECTORS.TABLE_DELETE_BUTTON).prop("disabled",!0):$(SELECTORS.TABLE_DELETE_BUTTON).prop("disabled",!1)},registerEventListeners=(userid,courseid,coursemoduleid)=>{this.userid=userid,this.courseid=courseid,this.coursemoduleid=coursemoduleid,this.$table=$(SELECTORS.NOTE_TABLE),$(SELECTORS.NOTEINDEX).on("click",SELECTORS.REFRESH_BUTTON,(function(){refreshNotes()})),$(SELECTORS.NOTEINDEX).on("click",SELECTORS.NOTE_TABLE_ROW+" td:not(:first-child)",(function(e){if(!$(e.target).hasClass("context-note")&&!$(e.target).parent().hasClass("context-note")){let noteid=$(this).closest("tr").find(".viewnote").data("noteid");$(SELECTORS.NOTEINDEX+" #notebook-table-index tr.selected").removeClass("selected"),displayNote(noteid),$(this).closest("tr").addClass("selected")}})),$(SELECTORS.NOTEINDEX).on("click",SELECTORS.NOTE_TABLE_ROW+" td:first-child",(function(e){if($(this).find(".card-views").length){if(!$(e.target).is("label, input")&&!$(e.target).hasClass("context-note")&&!$(e.target).parent().hasClass("context-note")){let noteid=$(this).closest("tr").find(".viewnote").data("noteid");$(SELECTORS.NOTEINDEX+" #notebook-table-index tr.selected").removeClass("selected"),displayNote(noteid),$(this).closest("tr").addClass("selected"),window.scrollTo(0,$(SELECTORS.NOTE_DETAIL_CONTAINER).position().top)}}else $(this).find('input[type="checkbox"]').trigger("click")})),$(SELECTORS.NOTEINDEX).on("click",SELECTORS.HEADER_NOTE_EDIT,(function(){var noteid;noteid=$(this).data("noteid"),ajax.call([{methodname:"local_notebook_read_note",args:{noteid:noteid},done:function(result){result&&(isTinyMceEditor()?getTinyMce().setContent(result.summary):$(SELECTORS.FORM_CONTAINER+" #id_notebook_editoreditable").html(result.summary),$(SELECTORS.NOTE_FORM+" textarea").val($(SELECTORS.NOTE_VIEW+" .textareaorigin").val()),$(SELECTORS.NOTE_FORM+" textarea").trigger("change"),$(SELECTORS.NOTE_FORM+' input[name="subject"]').val(result.subject),$(SELECTORS.NOTE_FORM+' input[name="noteid"]').val(noteid),hideNoteView(SELECTORS.NOTE_FORM+' input[name="subject"]'),toggleSaveButton())},fail:notification.exception}])})),$(SELECTORS.NOTEINDEX).on("click",SELECTORS.CANCEL_BUTTON,(function(e){e.preventDefault();let noteid=$(SELECTORS.NOTE_FORM+' input[name="noteid"]').val();displayNote(noteid)})),$(SELECTORS.NOTEBOOKCONTAINER).on("click",SELECTORS.CANCEL_DELETE_BUTTON_SINGLE,(function(){closeConfirmDialogue("single",!0)})),$(SELECTORS.NOTEBOOKCONTAINER).on("click",SELECTORS.CANCEL_DELETE_BUTTON_MULTI,(function(){closeConfirmDialogue("multiple",!0)})),$(SELECTORS.NOTEINDEX).on("click",SELECTORS.DELETE_NOTE_BUTTON,(function(){let action="multiple";$(this).data("noteid")&&(action="single"),showConfirmDialogue(action)})),$(SELECTORS.NOTEBOOKCONTAINER).on("click",SELECTORS.CONFIRM_DELETE_BUTTON_SINGLE+" , "+SELECTORS.CONFIRM_DELETE_BUTTON_MULTI,submitDeleteAjax),$(SELECTORS.FORM_CONTAINER).on("submit","form",submitFormAjax),$(SELECTORS.NOTEINDEX).on("change",SELECTORS.CHECKBOX_LIST_NOTE+", "+SELECTORS.CHECKBOX_ALL_NOTE,toggleDeleteButton)};return{init:(userid,courseid,coursemoduleid)=>{registerEventListeners(userid,courseid,coursemoduleid),$(document).ready((function(){displayNotes()}))}}}));

//# sourceMappingURL=notebook_index.min.js.map