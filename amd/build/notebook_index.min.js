/**
 * Controls the notebook index.
 *
 * @module     local_notebook/notebook_index
 * @copyright  2022 Université de Montréal
 * @author     Issam Taboubi <issam.taboubi@umontreal.ca>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
require.config({enforceDefine:!0,shim:{bootstrapTable:["jquery"],bootstrapTableLocale:["jquery","bootstrapTable"],bootstrapTableLocaleMobile:["jquery","bootstrapTable"]},paths:{bootstrapTable:M.cfg.wwwroot+"/local/notebook/amd/build/bootstrap-table.min",bootstrapTableLocale:M.cfg.wwwroot+"/local/notebook/amd/build/bootstrap-table-locale-all.min",bootstrapTableLocaleMobile:M.cfg.wwwroot+"/local/notebook/amd/build/bootstrap-table-mobile.min"}}),define("local_notebook/notebook_index",["jquery","core/notification","core/str","core/ajax","core/templates","bootstrapTable","bootstrapTableLocale","bootstrapTableLocaleMobile"],(function($,notification,str,ajax,Templates){var SELECTORS_NOTEBOOKCONTAINER=".notebookcontainer",SELECTORS_NOTEINDEX='[data-region="notebook-index"]',SELECTORS_FORM_CONTAINER='[data-region="form-note"]',SELECTORS_NOTE_TABLE_CONTAINER="#notebook-table-index-container",SELECTORS_NOTE_TABLE="#notebook-table-index",SELECTORS_NOTE_TABLE_LOADING="#notebook-table-index-loading",SELECTORS_REFRESH_BUTTON='button[name="refresh"]',SELECTORS_SAVE_BUTTON="#savenote",SELECTORS_CANCEL_BUTTON="#cancel-add-edit",SELECTORS_NOTE_VIEW='[data-region="notebook-index"] .view-note',SELECTORS_NOTE_TABLE_ROW="#notebook-table-index tr",SELECTORS_FOOTER_NOTE_VIEW='[data-region="footer-container"] [data-region="view-note"]',SELECTORS_HEADER_NOTE_VIEW='[data-region="header-container"] [data-region="view-note"]',SELECTORS_HEADER_NOTE_CREATED_DATE='[data-region="header-container"] .notecreateddate',SELECTORS_HEADER_NOTE_LAST_MODIFIED_DATE='[data-region="header-container"] .notelastmodifieddate',SELECTORS_NOTE_FORM='[data-region="form-note"] #noteform',SELECTORS_HEADER_NOTE_DELETE='[data-region="header-container"] .deletenote',SELECTORS_HEADER_NOTE_EDIT='[data-region="header-container"] .editnote',SELECTORS_FOOTER_NOTE_TAGS='[data-region="footer-container"] .notetags',SELECTORS_MESSAGE_SUCCESS_CONTAINER=".notebookcontainer .messagesuccesscontainer",SELECTORS_DIALOGUE_CONTAINER='.notebookcontainer [data-region="confirm-dialogue-container"]',SELECTORS_CONFIRM_TEXT_MULTI='.notebookcontainer [data-region="confirm-dialogue-container"] .multiplenotes',SELECTORS_CONFIRM_TEXT_SINGLE='.notebookcontainer [data-region="confirm-dialogue-container"] .singlenote',SELECTORS_CONFIRM_DELETE_BUTTON_MULTI='[data-region="confirm-dialogue-container"] [data-action="confirm-delete-multiple"]',SELECTORS_CONFIRM_DELETE_BUTTON_SINGLE='[data-region="confirm-dialogue-container"] [data-action="confirm-delete-single"]',SELECTORS_CANCEL_DELETE_BUTTON_MULTI='[data-region="confirm-dialogue-container"] [data-action="cancel-delete-multiple"]',SELECTORS_CANCEL_DELETE_BUTTON_SINGLE='[data-region="confirm-dialogue-container"] [data-action="cancel-delete-single"]',SELECTORS_DELETE_NOTE_BUTTON=".deletenote",SELECTORS_CHECKBOX_LIST_NOTE='[name="btSelectItem"]',SELECTORS_CHECKBOX_ALL_NOTE='[name="btSelectAll"]',SELECTORS_TABLE_DELETE_BUTTON='[data-region="notebook-index"] #remove',SELECTORS_TABLE_PAGINATION='[data-region="notebook-index"] .fixed-table-pagination',SELECTORS_NOTE_DETAIL_CONTAINER="#notedetailcontainer",refreshNotes=()=>{let previousPageNumber=this.$table.bootstrapTable("getOptions").pageNumber;this.$table.bootstrapTable("destroy"),displayNotes(previousPageNumber)},displayNote=noteid=>{var promises=[];displayNoteView(),$(SELECTORS_FOOTER_NOTE_VIEW+", "+SELECTORS_HEADER_NOTE_CREATED_DATE+", "+SELECTORS_HEADER_NOTE_LAST_MODIFIED_DATE+", "+SELECTORS_NOTE_VIEW).addClass("blur-content"),(promises=ajax.call([{methodname:"local_notebook_read_note",args:{noteid:noteid}},{methodname:"local_notebook_note_viewed",args:{id:noteid}}]))[0].done((function(result){let data={};data.subject=result.subject,data.summary=result.summary;let timestamp=1e3*result.created,datecreation=new Date(timestamp).toLocaleDateString(document.documentElement.lang,{day:"numeric",month:"short",year:"numeric"}),timecreation=new Date(timestamp).toLocaleTimeString(document.documentElement.lang),lastmodifiedtimestamp=1e3*result.lastmodified,lastmodifieddate=new Date(lastmodifiedtimestamp).toLocaleDateString(document.documentElement.lang,{day:"numeric",month:"short",year:"numeric"}),lastmodifiedtime=new Date(lastmodifiedtimestamp).toLocaleTimeString(document.documentElement.lang);Templates.render("local_notebook/note_content",data).then((function(html){var tags,tagshtml;$(SELECTORS_NOTE_VIEW).html(html),$(SELECTORS_HEADER_NOTE_CREATED_DATE).html(datecreation+" "+timecreation),$(SELECTORS_HEADER_NOTE_LAST_MODIFIED_DATE).html(lastmodifieddate+" "+lastmodifiedtime),$(SELECTORS_HEADER_NOTE_DELETE).data("noteid",result.id),$(SELECTORS_HEADER_NOTE_EDIT).data("noteid",result.id),$(SELECTORS_FOOTER_NOTE_TAGS).html((tags=result.tags,tagshtml="",tags.forEach((function(item){let badge="badge-info";"#"===item.url?(badge="badge-secondary",tagshtml+='<span class="badge '+badge+' text-truncate context-note" title="'+item.tooltip+'">'+item.title+"</span>"):tagshtml+='<span class="badge '+badge+' text-truncate context-note"><a title="'+item.tooltip+'" href="'+item.url+'">'+item.title+"</a></span>"})),tagshtml)),$(SELECTORS_FOOTER_NOTE_VIEW+", "+SELECTORS_HEADER_NOTE_CREATED_DATE+", "+SELECTORS_HEADER_NOTE_LAST_MODIFIED_DATE+", "+SELECTORS_NOTE_VIEW).removeClass("blur-content"),promises[1].done((function(){})).fail(Notification.exception)})).fail(Notification.exception)})).fail(Notification.exception)},displayNotes=pageNumber=>{var promises=[];promises=ajax.call([{methodname:"local_notebook_notes_list",args:{userid:this.userid,courseid:this.courseid,coursemoduleid:this.coursemoduleid}}]);str.get_strings([{key:"notetitle",component:"local_notebook"},{key:"notedate",component:"local_notebook"},{key:"displaynote",component:"local_notebook"},{key:"lastmodifieddate",component:"local_notebook"}]).then((function(langStrings){let data=[];promises[0].done((function(result){$.each(result,(function(index,value){let subject={};subject.text=value.subject,subject.tags=value.tags,data.push({id:value.id,subjecttext:value.subject,subject:subject,lastmodified:value.lastmodified})})),this.$table.bootstrapTable({locale:document.documentElement.lang,paginationParts:["pageInfo","pageSize","pageList"],paginationSuccessivelySize:2,paginationPagesBySide:1,data:data,pageNumber:pageNumber,columns:[[{field:"state",checkbox:!0},{field:"subjecttext",visible:!1},{field:"subject",title:langStrings[0],sortable:!0,sortName:"subjecttext",formatter:function(value){let nbtags=value.tags.length;var td="<span class='text-truncate subject'>"+value.text+"</span><br>",nbclass=1===nbtags?"wcn-1":"wcn-2";return value.tags.forEach((function(item){let badge="badge-info";"#"===item.url?(badge="badge-secondary",td+='<span class="badge '+badge+" text-truncate context-note "+nbclass+'" title="'+item.tooltip+'">'+item.title+"</span>"):td+='<span class="badge '+badge+" text-truncate context-note "+nbclass+'"><a title="'+item.tooltip+'" href="'+item.url+'">'+item.title+"</a></span>"})),td}},{field:"lastmodified",title:langStrings[1],sortable:!0,formatter:function(value){return new Date(1e3*value).toLocaleDateString(document.documentElement.lang,{day:"numeric",month:"short",year:"numeric"})},width:110,titleTooltip:langStrings[3]},{field:"operate",title:"",align:"center",width:35,formatter:function(value,row){return['<a class="viewnote" data-noteid="'+row.id+'" href="#notedetailcontainer" title="'+langStrings[2]+'">','<i class="fa fa-chevron-right" aria-hidden="true"></i>',"</a>"].join("")}}]],onPostBody:function(){$(".card-views").each((function(){$(this).find(".card-view").slice(1,3).wrapAll('<div class="item-content" />')})),$(SELECTORS_TABLE_PAGINATION+" .dropdown-toggle").dropdown(),$(SELECTORS_NOTE_TABLE_LOADING).addClass("hidden"),$(SELECTORS_NOTE_TABLE_CONTAINER).removeClass("hidden")}})})).fail(notification.exception)})).fail(Notification.exception)},closeConfirmDialogue=(action,focus)=>{$(SELECTORS_DIALOGUE_CONTAINER).addClass("hidden"),focus&&("multiple"===action?$(SELECTORS_TABLE_DELETE_BUTTON).focus():$(SELECTORS_DELETE_NOTE_BUTTON).focus())},showConfirmDialogue=action=>{if($(SELECTORS_DIALOGUE_CONTAINER).removeClass("hidden"),"multiple"===action){let toshow=SELECTORS_CONFIRM_TEXT_MULTI+", "+SELECTORS_CONFIRM_DELETE_BUTTON_MULTI+","+SELECTORS_CANCEL_DELETE_BUTTON_MULTI;$(SELECTORS_CONFIRM_TEXT_SINGLE+", "+SELECTORS_CONFIRM_DELETE_BUTTON_SINGLE+","+SELECTORS_CANCEL_DELETE_BUTTON_SINGLE).addClass("hidden"),$(toshow).removeClass("hidden");let list=[];$(SELECTORS_NOTEINDEX+" "+SELECTORS_CHECKBOX_LIST_NOTE+":checked").each((function(){list.push($(this).val())})),$(SELECTORS_CONFIRM_DELETE_BUTTON_MULTI).data("noteid",list),$(SELECTORS_CONFIRM_DELETE_BUTTON_MULTI).focus()}else{let toshow=SELECTORS_CONFIRM_TEXT_SINGLE+", "+SELECTORS_CONFIRM_DELETE_BUTTON_SINGLE+","+SELECTORS_CANCEL_DELETE_BUTTON_SINGLE;$(SELECTORS_CONFIRM_TEXT_MULTI+", "+SELECTORS_CONFIRM_DELETE_BUTTON_MULTI+","+SELECTORS_CANCEL_DELETE_BUTTON_MULTI).addClass("hidden"),$(toshow).removeClass("hidden"),$(SELECTORS_CONFIRM_DELETE_BUTTON_SINGLE).data("noteid",$(SELECTORS_HEADER_NOTE_DELETE).data("noteid")),$(SELECTORS_CONFIRM_DELETE_BUTTON_SINGLE).focus()}window.scrollTo(0,$(SELECTORS_DIALOGUE_CONTAINER).position().top)},submitFormAjax=()=>{if("reset"==$(document.activeElement).data("action"))cancelNoteForm();else{let args={};args.noteid=$(SELECTORS_NOTE_FORM+' input[name="noteid"]').val(),args.subject=$(SELECTORS_NOTE_FORM+' input[name="subject"]').val(),args.note=$(SELECTORS_NOTE_FORM).serialize(),ajax.call([{methodname:"local_notebook_update_note",args:args,done:function(result){result&&(refreshNotes(),displayMessageSuccess("notesaved"),displayNoteView(),displayNote(args.noteid))},fail:notification.exception}])}return!1},submitDeleteAjax=()=>{let action=$(document.activeElement).data("action"),notesids=[],keymessage="notedeleted";return"confirm-delete-multiple"===action?(notesids=$(document.activeElement).data("noteid"),keymessage="notedeletedmultiple"):notesids.push($(document.activeElement).data("noteid")),ajax.call([{methodname:"local_notebook_delete_notes",args:{notes:notesids},done:function(result){result&&(closeConfirmDialogue("multiple",!1),hideNoteView(!1),displayMessageSuccess(keymessage),refreshNotes(),hideNoteForm())},fail:notification.exception}]),!1},cancelNoteForm=()=>{displayNoteView(),$(SELECTORS_HEADER_NOTE_EDIT).focus()},hideNoteView=focus=>{$(SELECTORS_HEADER_NOTE_VIEW).addClass("hidden"),$(SELECTORS_HEADER_NOTE_VIEW).attr("aria-hidden",!0),$(SELECTORS_FOOTER_NOTE_VIEW).addClass("hidden"),$(SELECTORS_FOOTER_NOTE_VIEW).attr("aria-hidden",!0),$(SELECTORS_NOTE_VIEW).addClass("hidden"),$(SELECTORS_NOTE_VIEW).attr("aria-hidden",!0),$(SELECTORS_FORM_CONTAINER).removeClass("hidden"),$(SELECTORS_FORM_CONTAINER).removeAttr("aria-hidden"),focus&&$(focus).focus()},hideNoteForm=()=>{$(SELECTORS_FORM_CONTAINER).addClass("hidden"),$(SELECTORS_FORM_CONTAINER).attr("aria-hidden",!0)},displayNoteView=()=>{$(SELECTORS_HEADER_NOTE_VIEW).removeClass("hidden"),$(SELECTORS_HEADER_NOTE_VIEW).removeAttr("aria-hidden"),$(SELECTORS_FOOTER_NOTE_VIEW).removeClass("hidden"),$(SELECTORS_FOOTER_NOTE_VIEW).removeAttr("aria-hidden"),$(SELECTORS_NOTE_VIEW).removeClass("hidden"),$(SELECTORS_NOTE_VIEW).removeAttr("aria-hidden"),$(SELECTORS_FORM_CONTAINER).addClass("hidden"),$(SELECTORS_FORM_CONTAINER).attr("aria-hidden",!0)},displayMessageSuccess=key=>{$(SELECTORS_MESSAGE_SUCCESS_CONTAINER).html("");var stringkeys=[{key:key,component:"local_notebook"},{key:"close",component:"core"}];str.get_strings(stringkeys).then((function(langStrings){let messageHtml='<div class="alert alert-success alert-block fade in " role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="'+langStrings[1]+'">×</button>'+langStrings[0]+"</div>";$(SELECTORS_MESSAGE_SUCCESS_CONTAINER).html(messageHtml),$(SELECTORS_MESSAGE_SUCCESS_CONTAINER+" .alert button").focus(),setTimeout((function(){$(SELECTORS_MESSAGE_SUCCESS_CONTAINER+" .alert").fadeOut()}),1e4)}))},toggleSaveButton=()=>{let editorcontent=$(SELECTORS_FORM_CONTAINER+" #id_summary_editoreditable").html(),emptyeditor=!1,samecontent=!1;if("0"!==$(SELECTORS_NOTE_FORM+' input[name="noteid"]').val()){let subjectform=$(SELECTORS_NOTE_FORM+' input[type="text"]').val(),subjectorigin=$(SELECTORS_NOTEINDEX+" .titlenote").html(),summaryorigin=$(SELECTORS_NOTEINDEX+" .summarynote").html();0===subjectform.localeCompare(subjectorigin)&&0===editorcontent.localeCompare(summaryorigin)&&(samecontent=!0)}void 0===editorcontent||0!==editorcontent.replace(/<(.|\n)*?>/g,"").trim().length||editorcontent.includes("<img")||(emptyeditor=!0),""==$(SELECTORS_NOTE_FORM+' input[type="text"]').val()||emptyeditor||samecontent?$(SELECTORS_NOTE_FORM+" "+SELECTORS_SAVE_BUTTON).prop("disabled",!0):$(SELECTORS_NOTE_FORM+" "+SELECTORS_SAVE_BUTTON).prop("disabled",!1)},toggleDeleteButton=()=>{let listempty=!0;$(SELECTORS_NOTEINDEX+" "+SELECTORS_CHECKBOX_LIST_NOTE+":checked").length>0&&(listempty=!1),listempty?$(SELECTORS_TABLE_DELETE_BUTTON).prop("disabled",!0):$(SELECTORS_TABLE_DELETE_BUTTON).prop("disabled",!1)},registerEventListeners=(userid,courseid,coursemoduleid)=>{this.userid=userid,this.courseid=courseid,this.coursemoduleid=coursemoduleid,this.$table=$(SELECTORS_NOTE_TABLE),$(SELECTORS_NOTEINDEX).on("click",SELECTORS_REFRESH_BUTTON,(function(){refreshNotes()})),$(SELECTORS_NOTEINDEX).on("click",SELECTORS_NOTE_TABLE_ROW+" td:not(:first-child)",(function(e){if(!$(e.target).hasClass("context-note")&&!$(e.target).parent().hasClass("context-note")){let noteid=$(this).closest("tr").find(".viewnote").data("noteid");$(SELECTORS_NOTEINDEX+" #notebook-table-index tr.selected").removeClass("selected"),displayNote(noteid),$(this).closest("tr").addClass("selected")}})),$(SELECTORS_NOTEINDEX).on("click",SELECTORS_NOTE_TABLE_ROW+" td:first-child",(function(e){if($(this).find(".card-views").length){if(!$(e.target).is("label, input")&&!$(e.target).hasClass("context-note")&&!$(e.target).parent().hasClass("context-note")){let noteid=$(this).closest("tr").find(".viewnote").data("noteid");$(SELECTORS_NOTEINDEX+" #notebook-table-index tr.selected").removeClass("selected"),displayNote(noteid),$(this).closest("tr").addClass("selected"),window.scrollTo(0,$(SELECTORS_NOTE_DETAIL_CONTAINER).position().top)}}else $(this).find('input[type="checkbox"]').trigger("click")})),$(SELECTORS_NOTEINDEX).on("click",SELECTORS_HEADER_NOTE_EDIT,(function(){var noteid;noteid=$(this).data("noteid"),ajax.call([{methodname:"local_notebook_read_note",args:{noteid:noteid},done:function(result){result&&($(SELECTORS_FORM_CONTAINER+" #id_summary_editoreditable").html(result.summary),$(SELECTORS_NOTE_FORM+" textarea").val($(SELECTORS_NOTE_VIEW+" .textareaorigin").val()),$(SELECTORS_NOTE_FORM+" textarea").trigger("change"),$(SELECTORS_NOTE_FORM+' input[name="subject"]').val(result.subject),$(SELECTORS_NOTE_FORM+' input[name="noteid"]').val(noteid),hideNoteView(SELECTORS_NOTE_FORM+' input[name="subject"]'),toggleSaveButton())},fail:notification.exception}])})),$(SELECTORS_NOTEINDEX).on("click",SELECTORS_CANCEL_BUTTON,(function(e){e.preventDefault();let noteid=$(SELECTORS_NOTE_FORM+' input[name="noteid"]').val();displayNote(noteid)})),$(SELECTORS_NOTEBOOKCONTAINER).on("click",SELECTORS_CANCEL_DELETE_BUTTON_SINGLE,(function(){closeConfirmDialogue("single",!0)})),$(SELECTORS_NOTEBOOKCONTAINER).on("click",SELECTORS_CANCEL_DELETE_BUTTON_MULTI,(function(){closeConfirmDialogue("multiple",!0)})),$(SELECTORS_NOTEINDEX).on("click",SELECTORS_DELETE_NOTE_BUTTON,(function(){let action="multiple";$(this).data("noteid")&&(action="single"),showConfirmDialogue(action)})),$(SELECTORS_NOTEBOOKCONTAINER).on("click",SELECTORS_CONFIRM_DELETE_BUTTON_SINGLE+" , "+SELECTORS_CONFIRM_DELETE_BUTTON_MULTI,submitDeleteAjax),$(SELECTORS_FORM_CONTAINER).on("submit","form",submitFormAjax),$(SELECTORS_FORM_CONTAINER+' form input[type="text"]').on("input",toggleSaveButton),$(SELECTORS_FORM_CONTAINER+" form textarea").on("change",toggleSaveButton),$(SELECTORS_NOTEINDEX).on("change",SELECTORS_CHECKBOX_LIST_NOTE+", "+SELECTORS_CHECKBOX_ALL_NOTE,toggleDeleteButton)};return{init:(userid,courseid,coursemoduleid)=>{registerEventListeners(userid,courseid,coursemoduleid),$(document).ready((function(){displayNotes()}))}}}));

//# sourceMappingURL=notebook_index.min.js.map